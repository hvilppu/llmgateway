<mxfile host="app.diagrams.net" modified="2026-02-27" agent="Claude Code" version="21.0.0">
  <diagram name="LlmGateway Architecture" id="llmgateway-arch">
    <mxGraphModel dx="1422" dy="762" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1900" height="1400" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- ===== EXTERNAL: Client ===== -->
        <mxCell id="client" value="&lt;b&gt;Client&lt;/b&gt;&lt;br&gt;(HTTP caller)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="620" y="30" width="160" height="60" as="geometry" />
        </mxCell>

        <!-- ===== GATEWAY CONTAINER ===== -->
        <mxCell id="gateway" value="&lt;b&gt;LlmGateway — ASP.NET Core (.NET 10)&lt;/b&gt;" style="swimlane;fontStyle=1;fontSize=13;fillColor=#dae8fc;strokeColor=#6c8ebf;startSize=35;" vertex="1" parent="1">
          <mxGeometry x="60" y="140" width="1100" height="700" as="geometry" />
        </mxCell>

        <!-- HTTPS Redirection -->
        <mxCell id="https_mid" value="HTTPS Redirection Middleware" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;" vertex="1" parent="gateway">
          <mxGeometry x="420" y="50" width="220" height="45" as="geometry" />
        </mxCell>

        <!-- ChatEndpoints -->
        <mxCell id="chat_ep" value="&lt;b&gt;ChatEndpoints&lt;/b&gt;  POST /api/chat&lt;br&gt;&lt;br&gt;• Deserialize ChatRequest&lt;br&gt;• requestId from TraceIdentifier&lt;br&gt;• IsToolsEnabled? → agent loop or simple call&lt;br&gt;• Fallback model chain on error&lt;br&gt;• Error handling (503 / 502 / 500)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;align=left;spacingLeft=8;" vertex="1" parent="gateway">
          <mxGeometry x="360" y="140" width="330" height="140" as="geometry" />
        </mxCell>

        <!-- RoutingEngine -->
        <mxCell id="routing_eng" value="&lt;b&gt;RoutingEngine&lt;/b&gt; (singleton)&lt;br&gt;&lt;br&gt;ResolveModelChain(request)&lt;br&gt;→ [primary, fallback1, ...]&lt;br&gt;&lt;br&gt;IsToolsEnabled(request)&lt;br&gt;→ bool" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;align=left;spacingLeft=8;" vertex="1" parent="gateway">
          <mxGeometry x="50" y="150" width="260" height="130" as="geometry" />
        </mxCell>

        <!-- AzureOpenAIClient -->
        <mxCell id="az_client" value="&lt;b&gt;AzureOpenAIClient&lt;/b&gt; (typed HttpClient)&lt;br&gt;&lt;br&gt;• GetChatCompletionAsync — simple call&lt;br&gt;• GetRawCompletionAsync — tool calling&lt;br&gt;• GetEmbeddingAsync — RAG embeddings&lt;br&gt;• Circuit breaker check (IsOpen)&lt;br&gt;• Retry loop up to MaxRetries&lt;br&gt;• RecordSuccess / RecordFailure" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;align=left;spacingLeft=8;" vertex="1" parent="gateway">
          <mxGeometry x="730" y="140" width="300" height="175" as="geometry" />
        </mxCell>

        <!-- InMemoryCircuitBreaker -->
        <mxCell id="cb" value="&lt;b&gt;InMemoryCircuitBreaker&lt;/b&gt; (singleton)&lt;br&gt;&lt;br&gt;Per-model state in ConcurrentDictionary&lt;br&gt;Closed → Open → Half-Open → Closed&lt;br&gt;FailureThreshold | BreakDurationSeconds" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;align=left;spacingLeft=8;" vertex="1" parent="gateway">
          <mxGeometry x="730" y="450" width="300" height="100" as="geometry" />
        </mxCell>

        <!-- CosmosRagService -->
        <mxCell id="rag_svc" value="&lt;b&gt;CosmosRagService&lt;/b&gt; (singleton)&lt;br&gt;&lt;br&gt;Tool: search_documents&lt;br&gt;1. GetEmbeddingAsync(query) → float[]&lt;br&gt;2. VectorDistance query → top-K docs&lt;br&gt;3. Return content strings as context" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;align=left;spacingLeft=8;" vertex="1" parent="gateway">
          <mxGeometry x="50" y="390" width="290" height="120" as="geometry" />
        </mxCell>

        <!-- CosmosQueryService -->
        <mxCell id="query_svc" value="&lt;b&gt;CosmosQueryService&lt;/b&gt; (singleton)&lt;br&gt;&lt;br&gt;Tool: query_database&lt;br&gt;1. Validate SELECT-only (reject DML)&lt;br&gt;2. Execute Cosmos DB SQL query&lt;br&gt;3. Return results as JSON array" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;align=left;spacingLeft=8;" vertex="1" parent="gateway">
          <mxGeometry x="50" y="550" width="290" height="120" as="geometry" />
        </mxCell>

        <!-- OpenAPI -->
        <mxCell id="openapi_ep" value="OpenAPI&lt;br&gt;GET /openapi/v1.json&lt;br&gt;(Development only)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;" vertex="1" parent="gateway">
          <mxGeometry x="400" y="580" width="210" height="70" as="geometry" />
        </mxCell>

        <!-- Agent loop annotation -->
        <mxCell id="agent_loop_note" value="Agent loop (max 5 iterations):&lt;br&gt;GetRawCompletion → tool_calls → execute → repeat" style="text;html=1;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=middle;spacingLeft=8;rounded=1;fontSize=10;fontStyle=2;" vertex="1" parent="gateway">
          <mxGeometry x="360" y="320" width="330" height="50" as="geometry" />
        </mxCell>

        <!-- ===== EXTERNAL: Azure OpenAI Chat API ===== -->
        <mxCell id="az_chat_api" value="&lt;b&gt;Azure OpenAI Chat API&lt;/b&gt;&lt;br&gt;&lt;br&gt;POST /openai/deployments/&lt;br&gt;{deploymentName}/chat/completions&lt;br&gt;&lt;br&gt;Deployments: gpt4, gpt4oMini&lt;br&gt;Supports tools[] for function calling" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;fontSize=11;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="1260" y="200" width="260" height="160" as="geometry" />
        </mxCell>

        <!-- ===== EXTERNAL: Azure OpenAI Embeddings API ===== -->
        <mxCell id="az_embed_api" value="&lt;b&gt;Azure OpenAI Embeddings API&lt;/b&gt;&lt;br&gt;&lt;br&gt;POST /openai/deployments/&lt;br&gt;{embeddingDeployment}/embeddings&lt;br&gt;&lt;br&gt;Deployment: text-embedding-3-small" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;fontSize=11;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="1260" y="430" width="260" height="130" as="geometry" />
        </mxCell>

        <!-- ===== EXTERNAL: Cosmos DB ===== -->
        <mxCell id="cosmos_db" value="&lt;b&gt;Azure Cosmos DB NoSQL&lt;/b&gt;&lt;br&gt;&lt;br&gt;Documents: { id, content: {&lt;br&gt;  paikkakunta, pvm, lämpötila },&lt;br&gt;  embedding: float[] }&lt;br&gt;&lt;br&gt;• VectorDistance index on embedding&lt;br&gt;• SQL SELECT for aggregation" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;fontSize=11;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="1260" y="640" width="260" height="160" as="geometry" />
        </mxCell>

        <!-- ===== EXTERNAL: appsettings.json ===== -->
        <mxCell id="appsettings" value="&lt;b&gt;appsettings.json&lt;/b&gt;&lt;br&gt;&lt;br&gt;AzureOpenAI: Endpoint, ApiKey,&lt;br&gt;  EmbeddingDeployment,&lt;br&gt;  Deployments { gpt4, gpt4oMini }&lt;br&gt;Policies:&lt;br&gt;  chat_default → gpt4oMini&lt;br&gt;  critical → gpt4&lt;br&gt;  tools → gpt4, ToolsEnabled: true&lt;br&gt;CosmosRag: ConnectionString,&lt;br&gt;  DatabaseName, ContainerName, TopK&lt;br&gt;CircuitBreaker: FailureThreshold,&lt;br&gt;  BreakDurationSeconds" style="shape=note;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;align=left;spacingLeft=8;size=20;" vertex="1" parent="1">
          <mxGeometry x="60" y="920" width="300" height="220" as="geometry" />
        </mxCell>

        <!-- ===== LEGEND: Policy Routing ===== -->
        <mxCell id="policy_table" value="&lt;b&gt;Policy Routing&lt;/b&gt;&lt;br&gt;&lt;br&gt;null / missing → chat_default → gpt4oMini, simple&lt;br&gt;&quot;critical&quot;    → critical      → gpt4, simple + fallback&lt;br&gt;&quot;tools&quot;       → tools         → gpt4, agent loop&lt;br&gt;unknown       → chat_default  → gpt4oMini" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="430" y="930" width="380" height="110" as="geometry" />
        </mxCell>

        <!-- ===== LEGEND: Tools ===== -->
        <mxCell id="tools_table" value="&lt;b&gt;Function Calling Tools&lt;/b&gt;&lt;br&gt;&lt;br&gt;search_documents → CosmosRagService&lt;br&gt;  (semantic / explanatory questions)&lt;br&gt;&lt;br&gt;query_database → CosmosQueryService&lt;br&gt;  (aggregation: AVG, SUM, COUNT)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="430" y="1060" width="380" height="110" as="geometry" />
        </mxCell>

        <!-- ===== LEGEND: HTTP Responses ===== -->
        <mxCell id="http_table" value="&lt;b&gt;HTTP Responses&lt;/b&gt;&lt;br&gt;&lt;br&gt;200 OK  — Success&lt;br&gt;503     — Circuit breaker open&lt;br&gt;502     — Azure error&lt;br&gt;500     — Agent loop / unexpected error" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;align=left;spacingLeft=8;" vertex="1" parent="1">
          <mxGeometry x="880" y="930" width="260" height="120" as="geometry" />
        </mxCell>

        <!-- ===== EDGES ===== -->

        <!-- Client → HTTPS Middleware -->
        <mxCell id="e1" value="POST /api/chat" style="edgeStyle=orthogonalEdgeStyle;html=1;fontSize=10;fontStyle=1;" edge="1" source="client" target="https_mid" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- HTTPS Middleware → ChatEndpoints -->
        <mxCell id="e2" value="" style="edgeStyle=orthogonalEdgeStyle;html=1;" edge="1" source="https_mid" target="chat_ep" parent="gateway">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- ChatEndpoints → RoutingEngine -->
        <mxCell id="e3" value="ResolveModelChain / IsToolsEnabled" style="edgeStyle=orthogonalEdgeStyle;html=1;fontSize=9;" edge="1" source="chat_ep" target="routing_eng" parent="gateway">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- ChatEndpoints → AzureOpenAIClient -->
        <mxCell id="e4" value="GetChatCompletionAsync / GetRawCompletionAsync" style="edgeStyle=orthogonalEdgeStyle;html=1;fontSize=9;" edge="1" source="chat_ep" target="az_client" parent="gateway">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- ChatEndpoints → CosmosRagService (tool execution) -->
        <mxCell id="e_tool_rag" value="search_documents tool" style="edgeStyle=orthogonalEdgeStyle;html=1;fontSize=9;strokeColor=#82b366;" edge="1" source="chat_ep" target="rag_svc" parent="gateway">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- ChatEndpoints → CosmosQueryService (tool execution) -->
        <mxCell id="e_tool_query" value="query_database tool" style="edgeStyle=orthogonalEdgeStyle;html=1;fontSize=9;strokeColor=#82b366;" edge="1" source="chat_ep" target="query_svc" parent="gateway">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- AzureOpenAIClient → InMemoryCircuitBreaker -->
        <mxCell id="e5" value="IsOpen / RecordSuccess / RecordFailure" style="edgeStyle=orthogonalEdgeStyle;html=1;fontSize=9;" edge="1" source="az_client" target="cb" parent="gateway">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- CosmosRagService → AzureOpenAIClient (GetEmbeddingAsync) -->
        <mxCell id="e_rag_embed" value="GetEmbeddingAsync(query)" style="edgeStyle=orthogonalEdgeStyle;html=1;fontSize=9;dashed=1;strokeColor=#82b366;" edge="1" source="rag_svc" target="az_client" parent="gateway">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- AzureOpenAIClient → Azure OpenAI Chat API -->
        <mxCell id="e6" value="HTTP POST (chat/completions)" style="edgeStyle=orthogonalEdgeStyle;html=1;fontSize=9;fontStyle=1;exitX=1;exitY=0.3;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" source="az_client" target="az_chat_api" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Azure OpenAI Chat API → AzureOpenAIClient (response) -->
        <mxCell id="e7" value="200 / tool_calls / error" style="edgeStyle=orthogonalEdgeStyle;html=1;dashed=1;fontSize=9;exitX=0;exitY=0.7;exitDx=0;exitDy=0;entryX=1;entryY=0.6;entryDx=0;entryDy=0;" edge="1" source="az_chat_api" target="az_client" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- AzureOpenAIClient → Azure OpenAI Embeddings API -->
        <mxCell id="e_embed" value="HTTP POST (embeddings)" style="edgeStyle=orthogonalEdgeStyle;html=1;fontSize=9;strokeColor=#82b366;exitX=1;exitY=0.7;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" source="az_client" target="az_embed_api" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Azure OpenAI Embeddings API → AzureOpenAIClient (response) -->
        <mxCell id="e_embed_resp" value="float[] vector" style="edgeStyle=orthogonalEdgeStyle;html=1;dashed=1;fontSize=9;strokeColor=#82b366;exitX=0;exitY=0.7;exitDx=0;exitDy=0;entryX=1;entryY=0.85;entryDx=0;entryDy=0;" edge="1" source="az_embed_api" target="az_client" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- CosmosRagService → Cosmos DB -->
        <mxCell id="e_rag_cosmos" value="VectorDistance query (top-K)" style="edgeStyle=orthogonalEdgeStyle;html=1;fontSize=9;strokeColor=#82b366;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.3;entryDx=0;entryDy=0;" edge="1" source="rag_svc" target="cosmos_db" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- CosmosQueryService → Cosmos DB -->
        <mxCell id="e_query_cosmos" value="SQL SELECT query" style="edgeStyle=orthogonalEdgeStyle;html=1;fontSize=9;strokeColor=#82b366;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.7;entryDx=0;entryDy=0;" edge="1" source="query_svc" target="cosmos_db" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Retry self-loop on AzureOpenAIClient -->
        <mxCell id="e8" value="retry + exponential delay" style="edgeStyle=orthogonalEdgeStyle;html=1;dashed=1;fontSize=9;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;" edge="1" source="az_client" target="az_client" parent="gateway">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="880" y="110" />
              <mxPoint x="1060" y="110" />
              <mxPoint x="1060" y="140" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- ChatEndpoints → Client (response) -->
        <mxCell id="e9" value="ChatResponse (200/503/502/500)" style="edgeStyle=orthogonalEdgeStyle;html=1;dashed=1;fontSize=9;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=1;entryDx=0;entryDy=0;" edge="1" source="chat_ep" target="client" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="80" y="310" />
              <mxPoint x="80" y="60" />
              <mxPoint x="620" y="60" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- RoutingEngine → appsettings -->
        <mxCell id="e10" value="reads Policies + Deployments" style="edgeStyle=orthogonalEdgeStyle;html=1;dashed=1;strokeColor=#d6b656;fontSize=9;" edge="1" source="routing_eng" target="appsettings" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- AzureOpenAIClient → appsettings -->
        <mxCell id="e11" value="reads AzureOpenAI options" style="edgeStyle=orthogonalEdgeStyle;html=1;dashed=1;strokeColor=#d6b656;fontSize=9;" edge="1" source="az_client" target="appsettings" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- InMemoryCircuitBreaker → appsettings -->
        <mxCell id="e12" value="reads CB options" style="edgeStyle=orthogonalEdgeStyle;html=1;dashed=1;strokeColor=#d6b656;fontSize=9;" edge="1" source="cb" target="appsettings" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- CosmosRagService → appsettings -->
        <mxCell id="e13" value="reads CosmosRag options" style="edgeStyle=orthogonalEdgeStyle;html=1;dashed=1;strokeColor=#d6b656;fontSize=9;" edge="1" source="rag_svc" target="appsettings" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- CosmosQueryService → appsettings -->
        <mxCell id="e14" value="reads CosmosRag options" style="edgeStyle=orthogonalEdgeStyle;html=1;dashed=1;strokeColor=#d6b656;fontSize=9;" edge="1" source="query_svc" target="appsettings" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
